<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Arcuz: Behind the Dark - Mobile Fix</title>
    <script src="https://unpkg.com/@ruffle-rs/ruffle"></script>
    <style>
        * { box-sizing: border-box; touch-action: none; -webkit-user-select: none; user-select: none; }
        body, html { 
            margin: 0; padding: 0; width: 100%; height: 100%; 
            background: #000; overflow: hidden; position: fixed;
            display: flex; align-items: center; justify-content: center;
        }

        #game-container { width: 100vw; height: 100vh; display: flex; align-items: center; justify-content: center; z-index: 1; }
        ruffle-player { width: 100% !important; height: 100% !important; display: block; }

        /* ANALOG STICK */
        #stick-base {
            position: fixed; bottom: 40px; left: 40px;
            width: 120px; height: 120px;
            background: rgba(255,255,255,0.1); border: 2px solid rgba(255,255,255,0.3);
            border-radius: 50%; z-index: 100; pointer-events: auto;
            display: flex; align-items: center; justify-content: center;
        }
        #stick-knob { width: 50px; height: 50px; background: rgba(255,255,255,0.5); border: 2px solid #fff; border-radius: 50%; }

        /* BUTTONS */
        .ui-right { position: fixed; bottom: 30px; right: 20px; display: flex; flex-direction: column; gap: 10px; align-items: flex-end; z-index: 100; pointer-events: none; }
        .row { display: flex; gap: 8px; pointer-events: none; }
        .btn { 
            width: 50px; height: 50px; background: rgba(255,255,255,0.2); 
            border: 2px solid #fff; border-radius: 10px; display: flex; 
            align-items: center; justify-content: center; color: #fff; 
            pointer-events: auto; font-weight: bold; font-family: sans-serif;
        }
        .combat-btn { width: 75px; height: 75px; border-radius: 50%; font-size: 18px; }

        /* OVERLAY FIX */
        #overlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: #111; z-index: 9999; display: flex; 
            flex-direction: column; align-items: center; justify-content: center; 
        }
        #start-btn { 
            padding: 25px 50px; background: #27ae60; color: white; 
            border: 4px solid #fff; border-radius: 15px; font-size: 24px; font-weight: bold; cursor: pointer;
        }
    </style>
</head>
<body>

<div id="overlay">
    <h1 style="color:#f1c40f; font-family:sans-serif; margin-bottom: 20px;">ARCUZ LAYCHU MOBILE PORT</h1>
    <button id="start-btn">TAP TO PLAY</button>
</div>

<div id="game-container"></div>

<div id="stick-base"><div id="stick-knob"></div></div>

<div class="ui-right">
    <div class="row"><div class="btn" data-k="i">i</div><div class="btn" data-k="l">l</div></div>
    <div class="row"><div class="btn" data-k="1">1</div><div class="btn" data-k="2">2</div><div class="btn" data-k="3">3</div></div>
    <div class="row"><div class="btn combat-btn" style="background:rgba(231,76,60,0.5)" data-k="j">J</div>
                     <div class="btn combat-btn" style="background:rgba(52,152,219,0.5)" data-k="k">K</div></div>
</div>

<script>
    const ruffle = window.RufflePlayer.newest();
    const player = ruffle.createPlayer();
    const container = document.getElementById("game-container");
    container.appendChild(player);

    player.config = { "letterbox": "on", "scale": "showAll", "forceScale": true, "autoplay": "on" };
    player.load("Arcuz.swf");

    const keyCodes = { 'w':87,'a':65,'s':83,'d':68,'j':74,'k':75,'i':73,'l':76,'1':49,'2':50,'3':51 };
    let pressedKeys = new Set();

    function sendKey(k, type) {
        const event = new KeyboardEvent(type, {
            key: k, keyCode: keyCodes[k], which: keyCodes[k],
            code: isNaN(k) ? "Key"+k.toUpperCase() : "Digit"+k,
            bubbles: true, cancelable: true
        });
        player.dispatchEvent(event);
    }

    // ANALOG LOGIC
    const base = document.getElementById('stick-base');
    const knob = document.getElementById('stick-knob');
    let stickActive = false;

    const handleStick = (e) => {
        if (!stickActive) return;
        const rect = base.getBoundingClientRect();
        const touch = e.touches[0];
        let dx = touch.clientX - (rect.left + rect.width / 2);
        let dy = touch.clientY - (rect.top + rect.height / 2);
        const dist = Math.sqrt(dx*dx + dy*dy);
        const max = 40;
        if (dist > max) { dx *= max/dist; dy *= max/dist; }
        knob.style.transform = `translate(${dx}px, ${dy}px)`;
        const dz = 12;
        manage('w', dy < -dz); manage('s', dy > dz); manage('a', dx < -dz); manage('d', dx > dz);
    };

    function manage(key, down) {
        if (down && !pressedKeys.has(key)) { sendKey(key, 'keydown'); pressedKeys.add(key); }
        else if (!down && pressedKeys.has(key)) { sendKey(key, 'keyup'); pressedKeys.delete(key); }
    }

    base.addEventListener('touchstart', (e) => { stickActive = true; handleStick(e); });
    base.addEventListener('touchmove', (e) => { e.preventDefault(); handleStick(e); });
    base.addEventListener('touchend', () => {
        stickActive = false; knob.style.transform = `translate(0,0)`;
        ['w','a','s','d'].forEach(k => { if(pressedKeys.has(k)) { sendKey(k,'keyup'); pressedKeys.delete(k); } });
    });

    document.querySelectorAll('.btn').forEach(btn => {
        const k = btn.getAttribute('data-k');
        btn.addEventListener('touchstart', (e) => { e.preventDefault(); sendKey(k, 'keydown'); });
        btn.addEventListener('touchend', (e) => { e.preventDefault(); sendKey(k, 'keyup'); });
    });

    // START BUTTON FIX
    document.getElementById('start-btn').addEventListener('click', function() {
        const overlay = document.getElementById('overlay');
        overlay.style.opacity = '0';
        setTimeout(() => { overlay.remove(); }, 300); // Fully remove from screen
        
        if (document.documentElement.requestFullscreen) document.documentElement.requestFullscreen();
        
        player.play(); // Explicitly start the Ruffle engine
        player.focus();
    });
</script>
</body>
</html>
